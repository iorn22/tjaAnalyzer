<!DOCTYPE html>
<html lang="ja">
<head>
    <meta chrset="utf-8">
    <title>tja-Analyser</title>
    <style>
        #tja{
            width:100%;
        }
        #start{
            font-size:1.5em;
            width:5em;
            height:1.5em;
        }
        table{
            border-collapse:collapse;
        }
        table tr td{
            border:2px solid black;
            border-collapse:collapse;
            padding:10px;
        }
    </style>
</head>
<body>
    <h1>TJA-Analyser</h1>
    <h2>注意事項</h2>
    <ul>
        <li>#STARTと#ENDの間のみ記述してください</li>
        <li>最初に#BPMCHANGEで初期BPMを記述してください</li>
    </ul>
    <textarea id="tja" rows="15"></textarea>
    <button id="start" onclick="start()">分析</button>
    <hr>
    <table>
        <tr><td>コンボ数</td><td><span id="combo">1000</span></td></tr>
        <tr><td>演奏時間</td><td><span id="time">2:00</span></td></tr>
        <tr><td>平均密度</td><td><span id="density">8.33</span>打/s</td></tr>
        <tr><td>小節数</td><td><span id="barCnt">100</span></td></tr>
        <tr><td>面個数</td><td><span id="dongCnt">500</span></td></tr>
        <tr><td>縁個数</td><td><span id="kaCnt">500</span></td></tr>
        <tr><td>面割合</td><td><span id="dongRatio">50</span>%</td></tr>
        <tr><td>大音符個数</td><td><span id="bigCnt">50</span></td></tr>
        <tr><td>大音符割合</td><td><span id="bigRatio">5</span>%</td></tr>
        <tr><td>連打秒数(個別)</td><td><span id="rollTimeIndivi">4.000, 2.000, 3.000</span></td></tr>
        <tr><td>連打秒数</td><td><span id="rollTime">9.000</span></td></tr>
    </table>
    <script>
        // HTMLオブジェクト紐付け
        const tjaObj = document.getElementById("tja");
        const comboObj = document.getElementById("combo");
        const timeObj = document.getElementById("time");
        const densityObj = document.getElementById("density");
        const barCntObj = document.getElementById("barCnt");
        const dongCntObj = document.getElementById("dongCnt");
        const kaCntObj = document.getElementById("kaCnt");
        const dongRatioObj = document.getElementById("dongRatio");
        const bigCntObj = document.getElementById("bigCnt");
        const bigRatioObj = document.getElementById("bigRatio");
        const rollTimeIndiviObj = document.getElementById("rollTimeIndivi");
        const rollTimeObj = document.getElementById("rollTime");

        const tjaCommand = ["MEASURE", "BPMCHANGE"]; // 数値が後ろに来て有効なコマンド
        function start(){
            try{
            tja = tjaObj.value;
            tjaArr = tja.split("\n");
            currMeasure = 1; // 拍子初期値 4/4
            currBPM = 200; //BPM初期値 200
            var currBarLength; // 小節内数字数
            currBar = ""; // 小節毎譜面
            currBarTime = 0; // 
            barCnt = 0; // 小節数
            time = 0; // 演奏時間(s)
            introTime = 0; // 1コンボ目までの時間(s)
            outroTime = 0; // 最終コンボ目から演奏終了までの時間(s)
            currRollTime = -1; // 連打時間(-1なら非連打状態)
            rollTime = new Array(); // 連打時間(個別)
            rollTimeTotal = 0; // 連打時間(合計)
            notesCnt = 0; // 最大コンボ数
            dongCnt = 0; // 面個数
            bigCnt = 0; // 大音符個数
            for(i=0; i<tjaArr.length; i++){
                if(tjaArr[i].charAt(0) == "#"){ // コマンド行処理
                    j = 1;
                    commandName = "";
                    while(tjaArr[i].charAt(j) != " " && j < tjaArr[i].length + 1){
                        commandName = commandName + tjaArr[i].charAt(j);
                        j++;
                    };
                    if(tjaCommand.includes(commandName) == true){
                        j++;
                        commandIndex = "";
                        while(j < tjaArr[i].length + 1){
                            commandIndex = commandIndex + tjaArr[i].charAt(j);
                            j++;
                        };
                        if(commandName == "MEASURE"){
                            currMeasureArr = commandIndex.split("/");
                            currMeasure = Number(currMeasureArr[0]) / Number(currMeasureArr[1]);
                        }else if(commandName == "BPMCHANGE"){
                            currBPM = Number(commandIndex);
                        };
                    };
                }else if(tjaArr[i].charAt(0) == "/"){ // コメント行処理
                }else{ // 譜面データ行処理
                    for(j=0; j<tjaArr[i].length; j++){
                        if(tjaArr[i].charAt(j) == ","){ // 小節処理
                            barCnt++;
                            currBarLength = currBar.length; // 小節文字数
                            currBarTime = (60 / currBPM) * currMeasure * 4; // 小節長さ(s)
                            time += currBarTime;
                            if(currBarLength == 0){ // 空小節
                                outroTime += currBarTime;
                                if(currRollTime >= 0){ // 連打中
                                    currRollTime += currBarTime;
                                };
                                if(notesCnt == 0){
                                    introTime += currBarTime;
                                };
                            }else{
                                for(k=0; k<currBar.length; k++){
                                    if(currBar.charAt(k) == "0"){
                                        if(currRollTime >= 0){ // 連打中
                                            currRollTime += currBarTime / currBarLength;
                                        };
                                    }else if(currBar.charAt(k) == "1"){ // 面
                                        notesCnt++;
                                        dongCnt++;
                                        outroTime = 0;
                                    }else if(currBar.charAt(k) == "2"){ // 縁
                                        notesCnt++;
                                        outroTime = 0;
                                    }else if(currBar.charAt(k) == "3"){ // 面(大)
                                        notesCnt++;
                                        dongCnt++;
                                        bigCnt++;
                                        outroTime = 0;
                                    }else if(currBar.charAt(k) == "4"){ // 縁(大)
                                        notesCnt++;
                                        bigCnt++;
                                        outroTime = 0;
                                    }else if(currBar.charAt(k) == "5"){ // 連打
                                        currRollTime = currBarTime / currBarLength;                                       
                                    }else if(currBar.charAt(k) == "6"){ // 連打(大)
                                        currRollTime = currBarTime / currBarLength;                                       
                                    }else if(currBar.charAt(k) == "7"){ // 連打(風船)
                                        currRollTime = -2;
                                    }else if(currBar.charAt(k) == "8"){ // 連打(終)
                                        if(currRollTime > 0){
                                            rollTime.push(currRollTime);
                                        };
                                        currRollTime = -1;
                                    };
                                    if(notesCnt == 0){
                                        introTime += currBarTime / currBarLength;
                                    };
                                    outroTime += currBarTime / currBarLength;
                                };
                            };
                            currBar = "";
                        }else if(tjaArr[i].charAt(j) == "/"){ // コメント処理
                            break;
                        }else if(tjaArr[i].charAt(j) == " "){ // 空白処理
                        }else{
                            currBar = currBar + tjaArr[i].charAt(j);
                        };
                    };
                };
            };
            // 表示処理
            comboObj.innerText = notesCnt;
            timeDisp = String(Math.floor(time / 60)) + ":" + String(Math.floor(time % 60)).padStart(2, "0");
            timeObj.innerText = timeDisp;
            densityTime = time - introTime - outroTime;
            density = Math.floor(notesCnt / densityTime * 100) / 100;
            densityObj.innerText = density;
            barCntObj.innerText = barCnt;
            dongCntObj.innerText = dongCnt;
            kaCntObj.innerText = notesCnt - dongCnt;
            dongRatio = Math.floor(dongCnt / notesCnt * 1000) / 10;
            dongRatioObj.innerText = dongRatio;
            bigCntObj.innerText = bigCnt;
            bigRatio = Math.floor(bigCnt / notesCnt * 1000) / 10;
            bigRatioObj.innerText = bigRatio;
            dispRollTime = "";
            for(i=0; i<rollTime.length; i++){
                dispRollTime = dispRollTime + String(Math.floor(rollTime[i] * 1000) / 1000) + ", ";
                rollTimeTotal += rollTime[i];
            };
            if(dispRollTime == ""){
                dispRollTime = "精度曲"
            }else{
                dispRollTime = dispRollTime.substr(0, dispRollTime.length - 2)
            };
            rollTimeTotal = Math.floor(rollTimeTotal * 1000) / 1000;
            rollTimeIndiviObj.innerText = dispRollTime;
            rollTimeObj.innerText = rollTimeTotal;
            }catch(e){alert(e)};
        };
    </script>
</body>
</html>